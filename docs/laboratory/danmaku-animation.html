<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Danmaku Animation</title>
        <style>
            #app {
                position: relative;
                margin: auto;
                width: 960px;
                height: 600px;
                background-color: black;
            }
            .buttons {
                margin: 1em auto;
                width: 960px;
            }
        </style>
    </head>
    <body>
        <div id="app"></div>
        <div class="buttons">
            <button class="btn-fullscreen">全屏</button>
            <button class="btn-send">发射</button>
        </div>
        <script data-info="danmaku-lib">
            // prettier-ignore
            !function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var i in n)("object"==typeof exports?exports:e)[i]=n[i]}}(window,function(){return function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){e.exports=n(1)},function(e,t,n){"use strict";n.r(t);var i=function(){function e(e){this.text=e,this.domParser=new DOMParser,this.disinfectedText=this.text.replace(/[\x00-\x08\x0b-\x0c\x0e-\x1f\x7f]/g,""),this.doc=this.domParser.parseFromString(this.disinfectedText,"text/xml")}return e.prototype.getSingleNodeStringContent=function(e){var t=this.doc.querySelector(e);if(t&&null!=t.textContent)return t.textContent},e.prototype.getSingleNodeNumberContent=function(e){var t=this.doc.querySelector(e);if(t&&t.textContent)return Number(t.textContent)},e.prototype.getVarietyDanmakuEntries=function(e){var t=[],n=this.doc.getElementsByTagName(e);if(!n)return t;for(var i=0;i<n.length;i++){var r=n[i],o=r.textContent;if(o){var s=r.getAttribute("p");if(s){var a=s.split(",");if(!(a.length<8)){var h={start:Number(a.shift()),mode:Number(a.shift()),size:Number(a.shift()),color:Number(a.shift()),pubdate:Number(a.shift()),pool:Number(a.shift()),uhash:String(a.shift()),dmid:String(a.shift()),content:o};t.push(h)}}}}return t},e.prototype.parse=function(){var e={};return e.chatserver=this.getSingleNodeStringContent("chatserver"),e.chatid=this.getSingleNodeStringContent("chatid"),e.mission=this.getSingleNodeStringContent("mission"),e.maxlimit=this.getSingleNodeNumberContent("maxlimit"),e.source=this.getSingleNodeStringContent("source"),e.ds=this.getSingleNodeStringContent("ds"),e.de=this.getSingleNodeStringContent("de"),e.maxcount=this.getSingleNodeNumberContent("max_count"),e.entries=this.getVarietyDanmakuEntries("d"),e},e}(),r=1.125,o=function(){function e(){}return e.danmakuCompareFn=function(e,t){return e.start-t.start},e.getMeasuredTextWidth=function(e,t,n){void 0===n&&(n="normal normal normal normal 1rem/"+r+" sans-serif");var i=e.getContext("2d");return i?(i.font=n,i.measureText(t).width):0},e.getHexColor=function(e,t){void 0===t&&(t=!0);var n=("000000"+e.toString(16)).slice(-6);return t?"#"+n:n},e.getOutlineColor=function(e){return e?0:16777215},e.assign=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(e),r=0;r<t.length;r++){var o=t[r];if(null!=o)for(var s in o)Object.prototype.hasOwnProperty.call(o,s)&&(i[s]=o[s])}return i},e.isOrthogonalRectange=function(e,t){var n=e.x+e.width/2,i=e.y+e.height/2,r=t.x+t.width/2,o=t.y+t.height/2;return!!(Math.abs(n-r)<=(e.width+t.width)/2&&Math.abs(i-o)<=(e.height+t.height)/2)},e}(),s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function a(e,t){function n(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function h(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}}function l(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var i,r,o=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(i=o.next()).done;)s.push(i.value)}catch(e){r={error:e}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return s}function c(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(l(arguments[t]));return e}var f=function(){function e(e){this.entries=[],this.compareFn=e}return e.prototype.bsearchTargetIndex=function(e){for(var t=0,n=0,i=this.entries.length-1;t<=i;){n=Math.floor((t+i)/2);var r=this.compareFn(e,this.entries[n]);if(r<0)i=n-1;else{if(!(r>0))return n;t=n+1}}return-1},e.prototype.bsearchInsertionIndex=function(e){if(!this.entries.length)return 0;if(this.compareFn(e,this.entries[0])<=0)return 0;if(this.compareFn(e,this.entries[this.entries.length-1])>=0)return this.entries.length;for(var t=0,n=0,i=this.entries.length-1;t<=i;){n=Math.floor((t+i+1)/2);var r=this.compareFn(e,this.entries[n-1]),o=this.compareFn(e,this.entries[n]);if(r>=0&&o<=0)return n;if(r<0)i=n-1;else{if(!(r>0)){0;break}t=n+1}}return-1},e.prototype.binsert=function(e,t){var n;void 0===t&&(t=0);var i=-1,r=-1,o=-1,s=-1;switch(t?(r=(n=l(this.findInsertionIndex(e),3))[0],o=n[1],s=n[2]):r=o=s=this.bsearchInsertionIndex(e),!0){case t<0:i=r;break;case t>0:i=s;break;default:i=o}return i>-1&&this.entries.splice(i,0,e),this.entries.length},e.prototype.bremove=function(e){var t=[],n=this.bsearchTargetIndex(e);return n>-1&&t.push.apply(t,c(this.entries.splice(n,1))),t},e.prototype.binsertAll=function(e,t){var n=this;return void 0===t&&(t=0),e.forEach(function(e){n.binsert(e,t)}),this.entries.length},e.prototype.bremoveAll=function(e){var t=this,n=[];return e.forEach(function(e){n.push.apply(n,c(t.bremove(e)))}),n},e.prototype.findInsertionIndex=function(e){var t=this.bsearchInsertionIndex(e),n=t,i=t;if(t<0)return[n,t,i];for(;i+1<this.entries.length;){var r=this.compareFn(e,this.entries[i]),o=this.compareFn(e,this.entries[i+1]);if(!(r>=0&&o<=0))break;i+=1}for(i+1===this.entries.length&&this.compareFn(e,this.entries[this.entries.length-1])>=0&&(i=this.entries.length);n-1>0&&n-1<this.entries.length;){r=this.compareFn(e,this.entries[n-2]),o=this.compareFn(e,this.entries[n-1]);if(!(r>=0&&o<=0))break;n-=1}return 1===n&&this.compareFn(e,this.entries[0])<=0&&(n=0),[n,t,i]},e.prototype.findTargetIndex=function(e){var t=this.bsearchTargetIndex(e),n=t,i=t;if(t<0)return[n,t,i];for(;i+1<this.entries.length&&!this.compareFn(e,this.entries[i+1]);)i+=1;for(;n-1>=0&&n-1<this.entries.length&&!this.compareFn(e,this.entries[n-1]);)n-=1;return[n,t,i]},e.prototype.removeAllEquivalent=function(e,t){var n,i,r=this;void 0===t&&(t=!1);var o=[],s={};try{for(var a=h(e),f=a.next();!f.done;f=a.next()){var u=f.value,p=l(this.findTargetIndex(u),3),d=p[0],m=p[1],y=p[2];if(!(m<0))for(var g=d;g<y+1&&(this.entries[g]!==u||(null==s[g]?s[g]=1:s[g]++,!t));g++);}}catch(e){n={error:e}}finally{try{f&&!f.done&&(i=a.return)&&i.call(a)}finally{if(n)throw n.error}}return Object.keys(s).map(Number).sort(function(e,t){return t-e}).forEach(function(e){o.push.apply(o,c(r.entries.splice(e,1)))}),o},e.prototype.getItemsByPartialRange=function(e,t,n){void 0===n&&(n=1/0);var i=l(this.findInsertionIndex(e),1)[0],r=l(this.findInsertionIndex(t),1)[0];return this.getItemsByIndexRange(i,r,n)},e.prototype.getItemsByIndexRange=function(e,t,n){void 0===n&&(n=1/0);var i=[];if(e>=t)return i;for(;e<t;){if(e>=0&&e<this.entries.length){if(i.length>=n)break;i.push(this.entries[e])}e++}return i},e}(),u=function(){function e(e){var t;this.config=e,this.domElement=document.createElement("div"),this.timelineRaf=0,this.maxStackDepth=0,this.prevFrameTimeStamp=0,this.fpsSamples=[],this.fpsMaxSamples=5,this.stackDepthRestrict=2048,this.compositeFrameInterval=40,this.compositeFrameMinPeriod=5,this.viewportTree=new f(function(e,t){return e.entry.start-t.entry.start}),this.timelineTree=new f(o.danmakuCompareFn),this.sharedCanvas=document.createElement("canvas"),this.state={paused:!0,currentTime:0},this.zIndexLayout=((t={})[1]=[],t[6]=[],t[5]=[],t[4]=[],t),this.refreshMaxStackDepth(),this.genStageDetails()}return Object.defineProperty(e.prototype,"fps",{get:function(){if(this.fpsSamples.length){var e=this.fpsSamples.slice(-this.fpsMaxSamples),t=e.reduce(function(e,t){return e+t},0);return e.length>2?(e.length-2)/(t-Math.max.apply(Math,c(e))-Math.min.apply(Math,c(e))):0}return 0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"paused",{get:function(){return this.state.paused},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"currentTime",{get:function(){return this.state.currentTime},enumerable:!0,configurable:!0}),e.prototype.getItemsByTimeRange=function(e,t){var n=this;return this.timelineTree.getItemsByPartialRange({start:e},{start:t}).filter(function(e){return n.config.filter.call(null,e)})},e.prototype.compositeAll=function(e,t){var n=this;void 0===t&&(t=1/0);var i=[];if(!e.length)return i;var r=[],o=this.compositeFrameInterval/1e3,s=Math.min.apply(Math,c(e.map(function(e){return e.entry.start})));return e.forEach(function(e){var t=Math.floor((e.entry.start-s)/o),n=r[t];Array.isArray(n)?n.push(e):r[t]=[e]}),r.forEach(function(e){e&&e.length&&i.push.apply(i,c(n.composite(e,t)))}),i},e.prototype.composite=function(e,t){var n,i;void 0===t&&(t=1/0);var r=Math.max(this.compositeFrameMinPeriod,t)||1/0,o=[],s={},a=performance.now();try{for(var f=h(e),u=f.next();!u.done;u=f.next()){var p=u.value,d=0,m=[p,0,0];if(s[p.entry.mode]){var y=l(s[p.entry.mode],2);m=[p,y[0],y[1]]}for(;m&&d++<this.maxStackDepth;)m=this.getNextCompositeArguments.apply(this,c(m));if(p.composited&&(o.push(p),s[p.entry.mode]=[p.offsetY,p.zIndex]),performance.now()-a>r)break}}catch(e){n={error:e}}finally{try{u&&!u.done&&(i=f.return)&&i.call(f)}finally{if(n)throw n.error}}performance.now();return this.viewportTree.binsertAll(o),o},e.prototype.getNextCompositeArguments=function(e,t,n){var i=this.config.openLayers+(e.entry.highlight?1:0);if(!e.composited&&!(n&&n>i||e.y+e.height>this.config.canvasH)){if(t+e.y<0||t+e.y+e.height>this.config.canvasH)return[e,0,n+1];var r=this.zIndexLayout[e.entry.mode];if(Array.isArray(r)){for(;r.length<=n;)r.push(new f(function(e,t){return e.y-t.y}));var o=r[n],s=this.getTunedOffsetY(e,t,n);if(s)return[e,s,n];e.setLayoutDetails(t,n),o.binsert(e)}}},e.prototype.getTunedOffsetY=function(e,t,n){for(var i=this.zIndexLayout[e.entry.mode][n],r=l(i.findInsertionIndex({y:e.y+t}),1)[0],o=r<0?0:r;o<i.entries.length;o++){var s=i.entries[o];if(this.isIntersectionRectange(e,s,t)||this.isExceedingLinearSpeed(e,s,t))return s.y+s.height+1}return 0},e.prototype.isIntersectionRectange=function(e,t,n){return o.isOrthogonalRectange({x:e.x,y:n+e.y,width:e.width,height:e.height},{x:t.x,y:t.y,width:t.width,height:t.height})},e.prototype.isExceedingLinearSpeed=function(e,t,n){if(!o.isOrthogonalRectange({x:0,y:n+e.y,width:64,height:e.height},{x:0,y:t.y,width:64,height:t.height}))return!1;var i=e.averageLinearSpeed-t.averageLinearSpeed,r=Math.min(e.restTime,t.restTime)*Math.abs(i);return i>0?t.x+t.width<e.x?r>e.x-(t.x+t.width):!(e.x+e.width<t.x):i<0&&(e.x+e.width<t.x?r>t.x-(e.x+e.width):!(t.x+t.width<e.x))},e.prototype.refreshMaxStackDepth=function(){var e=Math.ceil(this.config.canvasH/12)*(Math.max(0,this.config.openLayers)+2);this.maxStackDepth=Math.min(e,this.stackDepthRestrict)||this.stackDepthRestrict},e.prototype.genStageDetails=function(){this.domElement.style.display="block",this.domElement.style.position="absolute",this.domElement.style.top="0%",this.domElement.style.left="50%",this.domElement.style.right="0%",this.domElement.style.bottom="0%",this.domElement.style.overflow="hidden",this.domElement.style.transform="translateX(-50%)",this.domElement.style.whiteSpace="pre",this.domElement.style.pointerEvents="none",this.domElement.style.width=this.config.canvasW+"px",this.domElement.style.height=this.config.canvasH+"px",this.domElement.style.lineHeight=r.toString(),this.config.container&&!this.domElement.parentElement&&this.config.container.appendChild(this.domElement)},e.prototype.nextTick=function(){var e=performance.now(),t=(e-this.prevFrameTimeStamp)/1e3,n=this.state.currentTime;for(this.state.currentTime=this.clockSynchronization(n,t),this.prevFrameTimeStamp=e,this.fpsSamples.push(t);this.fpsSamples.length>this.fpsMaxSamples;)this.fpsSamples.shift();return t},e.prototype.clockSynchronization=function(e,t){var n=+this.config.clock.call(null,e,t)||0;return n>=0&&n<1/0?n:e},e.prototype.nextAnimationFrame=function(e){var t=this.state.currentTime;this.nextTick(),this.refreshRendererDetails(),this.render(t,this.state.currentTime),this.timelineRaf=requestAnimationFrame(this.nextAnimationFrame.bind(this))},e.prototype.refreshRendererDetails=function(){var e,t,n=[];try{for(var i=h(this.viewportTree.entries),r=i.next();!r.done;r=i.next()){var o=r.value;if(!(o.entry.start+o.duration+.05<this.state.currentTime))break;n.push(o)}}catch(t){e={error:t}}finally{try{r&&!r.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}this.removeOutdatedScenesFromTrees(n)},e.prototype.removeOutdatedScenesFromTrees=function(e){var t=this;if(e.length){e.forEach(function(e){var n=t.zIndexLayout[e.entry.mode];n&&n[e.zIndex]&&n[e.zIndex].removeAllEquivalent([e],!0)});var n=this.viewportTree.removeAllEquivalent(e,!0);if(this.cleanOutdatedScenes(n),!this.config.reproducible){var i=e.map(function(e){return e.entry});this.timelineTree.removeAllEquivalent(i,!0)}}},e.prototype.requestDanmakuAnimation=function(){this.timelineRaf||(this.prevFrameTimeStamp=this.prevFrameTimeStamp||performance.now(),this.timelineRaf=requestAnimationFrame(this.nextAnimationFrame.bind(this)),this.state.paused=!1)},e.prototype.cancelDanmakuAnimation=function(){this.timelineRaf&&(cancelAnimationFrame(this.timelineRaf),this.nextTick(),this.prevFrameTimeStamp=0,this.timelineRaf=0,this.state.paused=!0)},e.prototype.refreshViewportTree=function(e){var t=l(this.timelineTree.findInsertionIndex({start:e}),1)[0];if(t>0){for(var n=null,i=t-1;i>=0;i--){var r=this.timelineTree.entries[i];if(!(r.start<e&&r.start+this.config.duration>=e))break;n=r.start}null!=n&&(this.render(n,e),this.viewportTree.entries.forEach(function(e){return e.repaintFrame()}))}},e.prototype.play=function(){this.timelineRaf||this.requestDanmakuAnimation()},e.prototype.pause=function(){this.timelineRaf&&this.cancelDanmakuAnimation()},e.prototype.seek=function(e,t){var n=Number(e),i=this.paused;n!==this.currentTime&&n>=0&&n<1/0&&!isNaN(n)&&(this.pause(),this.removeOutdatedScenesFromTrees(this.viewportTree.entries.slice(0)),this.state.currentTime=n,t&&this.refreshViewportTree(n),i?this.pause():this.play())},e.prototype.addAll=function(e){this.timelineTree.binsertAll(e)},e.prototype.resize=function(e,t){if(e>0||t>0){var n=this.config.canvasW;e&&(this.config.canvasW=e,this.config.scalableDuration&&(this.config.duration=e/n*this.config.duration)),t&&(this.config.canvasH=t),this.refreshMaxStackDepth(),this.genStageDetails(),this.viewportTree.entries.forEach(function(e){return e.resize()})}},e.prototype.search=function(e,t){return this.viewportTree.entries.filter(function(n){return o.isOrthogonalRectange({x:e,y:t,width:0,height:0},{x:n.x,y:n.y,width:n.width,height:n.height})})},e.prototype.dispose=function(){this.cancelDanmakuAnimation(),this.domElement.parentElement&&this.domElement.parentElement.removeChild(this.domElement)},e}(),p=function(e){function t(t,n,i,r,o){void 0===o&&(o=document.createElement("span"));var s=e.call(this,t,n,i)||this;return s.sharedStyle=r,s.node=o,s.aname=s.config.prefix+"_keyframe-"+s.entry.dmid,s}return a(t,e),t.prototype.genTextNodeDetails=function(){if(this.composited){switch(this.recalculateStyleReducer(!0),this.insertKeyframes(),this.node.style.left="",this.node.style.top="",this.node.style.right="",this.node.style.bottom="",this.node.style.outline="",this.entry.mode){case 5:this.node.style.top=this.initialY+"px",this.node.style.left="50%",this.node.style.transform="translateX(-50%)";break;case 4:this.node.style.bottom=this.initialY+"px",this.node.style.left="50%",this.node.style.transform="translateX(-50%)";break;case 6:this.node.style.top=this.initialY+"px",this.node.style.right="calc(100% + "+this.offsetX+"px)",this.node.style.transform="translateX(0px)";break;case 1:default:this.node.style.top=this.initialY+"px",this.node.style.left="calc(100% + "+this.offsetX+"px)",this.node.style.transform="translateX(0px)"}this.entry.highlight&&(this.node.style.outline="1px solid "+o.getHexColor(6750207)),this.node.style.fontFamily=this.config.fontFamily,this.node.style.fontWeight=this.config.fontWeight,this.node.textContent=this.entry.content,this.node.style.position="absolute",this.node.style.fontSize=this.fontSize+"px",this.node.style.color=o.getHexColor(this.entry.color),this.node.style.userSelect="none",this.node.style.textShadow="1px 0px 1px "+this.strokeColor+", \n                                          0px 1px 1px "+this.strokeColor+",\n                                          0px -1px 1px "+this.strokeColor+", \n                                          -1px 0px 1px "+this.strokeColor,this.node.style.zIndex=this.zIndex.toString(),this.node.setAttribute("data-dmid",this.entry.dmid),this.node.setAttribute("data-mode",this.entry.mode.toString()),this.node.style.animation=this.aname+" "+this.duration+"s linear 0s 1 normal forwards",this.node.style.animationPlayState="paused",this.node.style.display="inline-block"}},t.prototype.insertKeyframes=function(){if(this.sharedStyle.sheet){var e=this.sharedStyle.sheet,t=e.cssRules.length;switch(this.entry.mode){case 5:case 4:break;case 6:e.insertRule("\n                        @keyframes "+this.aname+" {\n                            from {\n                                transform: translateX(0px);\n                            }\n                            to {\n                                transform: translateX("+this.totalMotionDistance+"px);\n                            }\n                        }\n                    ",t);break;case 1:default:e.insertRule("\n                        @keyframes "+this.aname+" {\n                            from {\n                                transform: translateX(0px);\n                            }\n                            to {\n                                transform: translateX(-"+this.totalMotionDistance+"px);\n                            }\n                        }\n                    ",t)}}},t.prototype.deleteKeyframes=function(e){if(void 0===e&&(e=0),this.sharedStyle.sheet)for(var t=this.sharedStyle.sheet,n=Math.min(t.cssRules.length+e,t.cssRules.length),i=0;i<n;i++){var r=t.cssRules[i];if(r.type===CSSRule.KEYFRAMES_RULE&&r.name===this.aname){t.deleteRule(i);break}}},t.prototype.recalculateStyleReducer=function(e){switch(this.entry.mode){case 5:case 4:break;case 6:case 1:default:this.node.style.willChange=e?"transform":""}},t.prototype.refreshVisibilityStyle=function(e){this.state.visible=e,this.node.style.visibility=this.state.visible?"":"hidden"},t.prototype.show=function(){this.refreshVisibilityStyle(!0)},t.prototype.hide=function(){this.refreshVisibilityStyle(!1)},t.prototype.play=function(){e.prototype.play.call(this),this.node.style.animationPlayState="running"},t.prototype.pause=function(){e.prototype.pause.call(this),this.node.style.animationPlayState="paused"},t.prototype.resize=function(){this.insertKeyframes(),this.deleteKeyframes(-1),this.node.style.animationDuration=this.duration+"s"},t.prototype.repaintFrame=function(){this.node.style.animationDelay="-"+this.elapsedTime+"s"},t.prototype.dispose=function(e){e?this.node.parentElement&&this.node.parentElement.removeChild(this.node):(this.node.style.display="none",this.recalculateStyleReducer(!1)),this.deleteKeyframes()},t}(function(){function e(e,t,n){this.renderer=e,this.entry=t,this.sharedCanvas=n,this.state={zIndex:0,offsetX:1,offsetY:0,paused:!0,visible:!0,composited:!1},this.config=this.renderer.config,this.strokeColor=o.getHexColor(o.getOutlineColor(this.entry.color)),this.width=o.getMeasuredTextWidth(this.sharedCanvas,t.content,this.config.fontWeight+" "+this.fontSize+"px/"+r+" "+this.config.fontFamily),this.height=o.getMeasuredTextWidth(this.sharedCanvas,"中",this.config.fontWeight+" "+this.fontSize+"px/"+r+" "+this.config.fontFamily)*r}return Object.defineProperty(e.prototype,"paused",{get:function(){return this.state.paused},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"composited",{get:function(){return this.state.composited},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"visible",{get:function(){return this.state.visible},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"zIndex",{get:function(){return this.state.zIndex},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fontSize",{get:function(){return Math.floor(this.entry.size*this.config.fontScaling)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"elapsedTime",{get:function(){var e=this.renderer.currentTime-this.entry.start;return Math.min(Math.max(0,e),this.duration)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"restTime",{get:function(){var e=this.duration-this.elapsedTime;return Math.min(Math.max(0,e),this.duration)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"duration",{get:function(){return this.config.duration},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"totalMotionDistance",{get:function(){return this.config.canvasW+this.width+this.state.offsetX},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"elapsedMotionDistance",{get:function(){return this.elapsedTime/this.duration*this.totalMotionDistance},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"restMotionDistance",{get:function(){return this.restTime/this.duration*this.totalMotionDistance},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"averageLinearSpeed",{get:function(){return this.totalMotionDistance/this.duration},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"x",{get:function(){switch(this.entry.mode){case 5:case 4:return(this.config.canvasW-this.width)/2;case 6:case 1:default:return this.restMotionDistance-this.width}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this.state.offsetY},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"offsetX",{get:function(){return this.state.offsetX},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"offsetY",{get:function(){return this.state.offsetY},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"initialX",{get:function(){switch(this.entry.mode){case 5:case 4:return(this.config.canvasW-this.width)/2;case 6:case 1:default:return this.config.canvasW+this.state.offsetX}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"initialY",{get:function(){return this.state.offsetY},enumerable:!0,configurable:!0}),e.prototype.play=function(){this.state.paused=!1},e.prototype.pause=function(){this.state.paused=!0},e.prototype.setLayoutDetails=function(e,t){return!this.state.composited&&(this.state.offsetY=e,this.state.zIndex=t,this.state.composited=!0,this.genTextNodeDetails(),!0)},e}()),d=function(e){function t(t){var n=e.call(this,t)||this;return n.fragment=document.createDocumentFragment(),n.sharedStyle=document.createElement("style"),n.recycledNodes=[],n.appendSharedStyle(),n}return a(t,e),t.prototype.appendSharedStyle=function(){this.sharedStyle.setAttribute("data-sign",this.config.prefix+"-keyframes"),this.sharedStyle.title="This is a shared style for danmaku keyframes",this.domElement.ownerDocument&&this.domElement.ownerDocument.head&&!this.sharedStyle.parentElement&&this.domElement.ownerDocument.head.appendChild(this.sharedStyle)},t.prototype.render=function(e,t){var n=this,i=this.getItemsByTimeRange(e,t).map(function(e){return new p(n,e,n.sharedCanvas,n.sharedStyle,n.recycledNodes.shift())}),r=this.compositeAll(i);r.length&&(r.forEach(function(e){e.node.parentElement||n.fragment.appendChild(e.node)}),this.fragment.childNodes.length&&this.domElement.appendChild(this.fragment),this.refreshConnectedSceneAnimation(r))},t.prototype.cleanOutdatedScenes=function(e){var t,n;try{for(var i=h(e),r=i.next();!r.done;r=i.next()){var o=r.value;this.recycledNodes.length<this.config.recycledBufferSize?(this.recycledNodes.push(o.node),o.dispose()):o.dispose(!0)}}catch(e){t={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}},t.prototype.refreshConnectedSceneAnimation=function(e){var t=this.paused;(e||this.viewportTree.entries).forEach(function(e){return t?e.pause():e.play()})},t.prototype.play=function(){this.paused&&(e.prototype.play.call(this),this.refreshConnectedSceneAnimation())},t.prototype.pause=function(){this.paused||(e.prototype.pause.call(this),this.refreshConnectedSceneAnimation())},t.prototype.dispose=function(){e.prototype.dispose.call(this),this.recycledNodes.length=0,this.sharedStyle.parentElement&&this.sharedStyle.parentElement.removeChild(this.sharedStyle)},t}(u);n.d(t,"Danmaku",function(){return m});var m=function(){function e(t){this.input=t,this.config=o.assign(e.DEF_CONFIG,this.input),this.switchRendererType(this.config.rendererType)}return Object.defineProperty(e,"DEF_CONFIG",{get:function(){return{duration:5,openLayers:0,prefix:"danmaku",fontFamily:"SimHei, sans-serif",fontWeight:"700",fontScaling:1,reproducible:!0,scalableDuration:!0,data:{maxlimit:1e5},rendererType:0,recycledBufferSize:500,clock:function(e,t){return e+t},filter:function(e){return!0}}},enumerable:!0,configurable:!0}),Object.defineProperty(e,"Parser",{get:function(){return i},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"paused",{get:function(){return this.sharedRenderer.paused},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"domElement",{get:function(){return this.sharedRenderer.domElement},enumerable:!0,configurable:!0}),e.prototype.switchRendererType=function(e){switch(this.sharedRenderer&&this.sharedRenderer.dispose(),e){case 1:this.config.rendererType=e;break;case 0:this.config.rendererType=e,this.sharedRenderer=new d(this.config);break;default:throw new Error("Invalid `type` paramater")}this.config.data.entries&&this.sharedRenderer.addAll(this.config.data.entries.filter(function(e){return 0!==e.mode}))},e.prototype.setOptions=function(e,t){switch(e){case"openLayers":case"fontFamily":case"fontWeight":case"fontScaling":case"scalableDuration":case"recycledBufferSize":null!=t&&(this.config[e]=t)}},e.prototype.play=function(){this.sharedRenderer.play()},e.prototype.pause=function(){this.sharedRenderer.pause()},e.prototype.resize=function(e,t){this.sharedRenderer.resize(e,t)},e}()}])});
        </script>
        <script>
            fetch("../assets/2428566.xml")
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    } else {
                        throw new Error(response.statusText);
                    }
                })
                .then(text => {
                    return new Danmaku.Parser(text);
                })
                .then(parser => {
                    return parser.parse();
                })
                .then(data => {
                    const rtl = Object.assign({}, data, {
                        entries: data.entries.filter(x => x.mode === 1 || x.mode === 6),
                    });
                    const ttb = Object.assign({}, data, {
                        entries: data.entries.filter(x => x.mode === 4 || x.mode === 5),
                    });
                    window.d1 = new Danmaku({
                        canvasW: 960,
                        canvasH: 600,
                        container: document.getElementById("app"),
                        data: rtl,
                        duration: 5,
                        openLayers: 0,
                        fontFamily: "SimSun, sans-serif",
                        fontWeight: "700",
                        reproducible: true,
                        recycledBufferSize: 500,
                    });
                    window.d2 = new Danmaku({
                        canvasW: 960,
                        canvasH: 600,
                        // container: document.getElementById("app"),
                        data: ttb,
                        duration: 3,
                        openLayers: 0,
                        fontFamily: "SimHei, sans-serif",
                    });
                });
            app.onclick = e => {
                if (d1.paused) {
                    d1.play();
                    d2.play();
                } else {
                    d1.pause();
                    d2.pause();
                }
            };
            app.onfullscreenchange = e => {
                console.info(app.clientWidth, app.clientHeight);
                d1.resize(app.clientWidth, app.clientHeight);
                d2.resize(app.clientWidth, app.clientHeight);
            };
            document.querySelector(".btn-fullscreen").onclick = e => {
                app.requestFullscreen();
            };
            document.querySelector(".btn-send").onclick = e => {
                d1.sharedRenderer.addAll([
                    {
                        start: d1.sharedRenderer.currentTime,
                        mode: 1,
                        size: 32,
                        color: 0xffffff,
                        pubdate: Math.floor(Date.now() / 1000),
                        pool: 0,
                        uhash: "",
                        dmid: Math.random()
                            .toString()
                            .slice(2, 12),
                        content: "测试测试123123哔哩哔哩",
                        highlight: true,
                    },
                ]);
            };
            document.oncontextmenu = e => {
                const rect = app.getBoundingClientRect();
                console.log(d1.sharedRenderer.search(e.pageX - rect.x, e.pageY - rect.y));
            };
        </script>
    </body>
</html>
